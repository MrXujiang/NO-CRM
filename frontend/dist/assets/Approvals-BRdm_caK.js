import{C as B,d as te,r as c,D as ae,l as le,b as p,c as F,e as _,h as l,w as t,i as o,p as u,m as A,o as s,n as oe,t as m,M as w,_ as ne}from"./index-BQBF81MK.js";import{o as G}from"./order-kzB7aZ2c.js";const P={getPending(b=1,y=10){return B.get("/orders",{params:{status:"pending",page:b,pageSize:y}})},approve(b,y,S){return B.post(`/orders/${b}/approve`,{approved:y,notes:S})},getMyApprovals(b=1,y=10){return B.get("/orders/my-approvals",{params:{page:b,pageSize:y}})}},se={class:"approvals-page"},ue={class:"page-header"},re={key:0},de={style:{color:"#e34d59","font-size":"18px","font-weight":"bold"}},ie={key:0,style:{"margin-top":"24px","padding-top":"24px","border-top":"1px solid #e7e7e7"}},pe={style:{padding:"16px 0"}},ve={style:{"margin-bottom":"16px"}},me=te({__name:"Approvals",setup(b){const y=c(!1),S=c([]),V=c("pending"),K=c(!1),h=c(!1),n=c(null),g=c(""),k=c(!0),U=c(0),v=ae({current:1,pageSize:10,total:0}),H=[{colKey:"orderNo",title:"订单编号",width:150},{colKey:"title",title:"订单标题",width:200},{colKey:"totalAmount",title:"订单金额",width:120,cell:"totalAmount"},{colKey:"requireApproval",title:"需要审批",width:100,cell:"requireApproval"},{colKey:"status",title:"状态",width:100,cell:"status"},{colKey:"approvalStatus",title:"审批结果",width:100,cell:"approvalStatus"},{colKey:"orderDate",title:"下单日期",width:150},{colKey:"action",title:"操作",width:220,cell:"action",fixed:"right"}],J=[{colKey:"productName",title:"产品名称",width:200},{colKey:"quantity",title:"数量",width:80},{colKey:"unit",title:"单位",width:80},{colKey:"unitPrice",title:"单价",width:100},{colKey:"discount",title:"折扣",width:100},{colKey:"amount",title:"小计",width:120}],C=async()=>{var r,e;y.value=!0;try{let i;V.value==="pending"?i=await P.getPending(v.current,v.pageSize):V.value==="approved"?i=await G.getAll("approved",void 0,v.current,v.pageSize):i=await G.getAll(void 0,void 0,v.current,v.pageSize),S.value=i.data,v.total=i.total}catch(i){w.error(((e=(r=i.response)==null?void 0:r.data)==null?void 0:e.message)||"加载数据失败")}finally{y.value=!1}},z=async()=>{try{const r=await P.getPending(1,100);U.value=r.total}catch(r){console.error("加载待审批数量失败",r)}},L=()=>{v.current=1,C()},Q=()=>{C()},R=r=>{n.value=r,g.value=r.approvalNotes||"",K.value=!0},M=(r,e)=>{n.value=r,k.value=e,g.value="",h.value=!0},j=async(r,e)=>{var i,x;try{await P.approve(r.id,e,g.value),w.success(e?"审批通过":"已驳回订单"),K.value=!1,g.value="",C(),z()}catch(N){w.error(((x=(i=N.response)==null?void 0:i.data)==null?void 0:x.message)||"操作失败")}},W=async()=>{var r,e;if(n.value)try{await P.approve(n.value.id,k.value,g.value),w.success(k.value?"审批通过":"已驳回订单"),h.value=!1,g.value="",C(),z()}catch(i){w.error(((e=(r=i.response)==null?void 0:r.data)==null?void 0:e.message)||"操作失败")}};return le(()=>{C(),z()}),(r,e)=>{const i=p("t-icon"),x=p("t-button"),N=p("t-badge"),q=p("t-space"),D=p("t-tab-panel"),X=p("t-tabs"),Y=p("t-card"),d=p("t-tag"),$=p("t-link"),O=p("t-table"),Z=p("t-pagination"),f=p("t-descriptions-item"),ee=p("t-descriptions"),T=p("t-textarea"),E=p("t-dialog");return s(),F("div",se,[_("div",ue,[e[10]||(e[10]=_("h2",null,"审批中心",-1)),l(q,null,{default:t(()=>[l(N,{count:U.value,"max-count":99},{default:t(()=>[l(x,{theme:"primary",onClick:z},{icon:t(()=>[l(i,{name:"refresh"})]),default:t(()=>[e[9]||(e[9]=o(" 刷新 ",-1))]),_:1})]),_:1},8,["count"])]),_:1})]),l(Y,{class:"filter-card"},{default:t(()=>[l(X,{modelValue:V.value,"onUpdate:modelValue":e[0]||(e[0]=a=>V.value=a),onChange:L},{default:t(()=>[l(D,{value:"pending",label:"待审批"},{label:t(()=>[l(N,{count:U.value,"max-count":99,offset:[10,0]},{default:t(()=>[...e[11]||(e[11]=[o(" 待审批 ",-1)])]),_:1},8,["count"])]),_:1}),l(D,{value:"approved",label:"已审批"}),l(D,{value:"all",label:"全部记录"})]),_:1},8,["modelValue"])]),_:1}),l(O,{data:S.value,columns:H,loading:y.value,"row-key":"id",stripe:"",hover:"",class:"data-table"},{status:t(({row:a})=>[a.status==="pending"?(s(),u(d,{key:0,theme:"warning"},{default:t(()=>[...e[12]||(e[12]=[o("待审批",-1)])]),_:1})):a.status==="approved"?(s(),u(d,{key:1,theme:"success"},{default:t(()=>[...e[13]||(e[13]=[o("已审批",-1)])]),_:1})):a.status==="draft"?(s(),u(d,{key:2,theme:"default"},{default:t(()=>[...e[14]||(e[14]=[o("已驳回",-1)])]),_:1})):(s(),u(d,{key:3},{default:t(()=>[o(m(a.status),1)]),_:2},1024))]),approvalStatus:t(({row:a})=>[a.approvalStatus==="approved"?(s(),u(d,{key:0,theme:"success"},{default:t(()=>[...e[15]||(e[15]=[o("通过",-1)])]),_:1})):a.approvalStatus==="rejected"?(s(),u(d,{key:1,theme:"danger"},{default:t(()=>[...e[16]||(e[16]=[o("驳回",-1)])]),_:1})):(s(),u(d,{key:2,theme:"default"},{default:t(()=>[...e[17]||(e[17]=[o("-",-1)])]),_:1}))]),totalAmount:t(({row:a})=>[_("span",{style:oe({color:a.totalAmount>5e4?"#e34d59":"#000"})}," ¥"+m(a.totalAmount.toFixed(2)),5)]),requireApproval:t(({row:a})=>[a.requireApproval?(s(),u(d,{key:0,theme:"primary"},{default:t(()=>[...e[18]||(e[18]=[o("是",-1)])]),_:1})):(s(),u(d,{key:1,theme:"default"},{default:t(()=>[...e[19]||(e[19]=[o("否",-1)])]),_:1}))]),action:t(({row:a})=>[l(q,null,{default:t(()=>[l($,{theme:"primary",onClick:I=>R(a)},{default:t(()=>[...e[20]||(e[20]=[o("查看详情",-1)])]),_:1},8,["onClick"]),a.status==="pending"?(s(),u($,{key:0,theme:"success",onClick:I=>M(a,!0)},{default:t(()=>[...e[21]||(e[21]=[o(" 通过 ",-1)])]),_:1},8,["onClick"])):A("",!0),a.status==="pending"?(s(),u($,{key:1,theme:"danger",onClick:I=>M(a,!1)},{default:t(()=>[...e[22]||(e[22]=[o(" 驳回 ",-1)])]),_:1},8,["onClick"])):A("",!0)]),_:2},1024)]),_:1},8,["data","loading"]),l(Z,{modelValue:v.current,"onUpdate:modelValue":e[1]||(e[1]=a=>v.current=a),pageSize:v.pageSize,"onUpdate:pageSize":e[2]||(e[2]=a=>v.pageSize=a),total:v.total,"show-jumper":"",onChange:Q},null,8,["modelValue","pageSize","total"]),l(E,{visible:K.value,"onUpdate:visible":e[6]||(e[6]=a=>K.value=a),header:"订单详情",width:"800px",footer:!1},{default:t(()=>[n.value?(s(),F("div",re,[l(ee,{column:2,bordered:""},{default:t(()=>[l(f,{label:"订单编号"},{default:t(()=>[o(m(n.value.orderNo),1)]),_:1}),l(f,{label:"订单状态"},{default:t(()=>[n.value.status==="pending"?(s(),u(d,{key:0,theme:"warning"},{default:t(()=>[...e[23]||(e[23]=[o("待审批",-1)])]),_:1})):n.value.status==="approved"?(s(),u(d,{key:1,theme:"success"},{default:t(()=>[...e[24]||(e[24]=[o("已审批",-1)])]),_:1})):(s(),u(d,{key:2},{default:t(()=>[o(m(n.value.status),1)]),_:1}))]),_:1}),l(f,{label:"订单标题",span:2},{default:t(()=>[o(m(n.value.title),1)]),_:1}),l(f,{label:"小计金额"},{default:t(()=>{var a;return[o("¥"+m((a=n.value.subtotal)==null?void 0:a.toFixed(2)),1)]}),_:1}),l(f,{label:"折扣金额"},{default:t(()=>{var a;return[o("¥"+m((a=n.value.discount)==null?void 0:a.toFixed(2)),1)]}),_:1}),l(f,{label:"订单总额",span:2},{default:t(()=>{var a;return[_("span",de," ¥"+m((a=n.value.totalAmount)==null?void 0:a.toFixed(2)),1)]}),_:1}),l(f,{label:"需要审批",span:2},{default:t(()=>[n.value.requireApproval?(s(),u(d,{key:0,theme:"primary"},{default:t(()=>[...e[25]||(e[25]=[o("是",-1)])]),_:1})):(s(),u(d,{key:1,theme:"default"},{default:t(()=>[...e[26]||(e[26]=[o("否",-1)])]),_:1}))]),_:1}),l(f,{label:"审批状态",span:2},{default:t(()=>[n.value.approvalStatus==="approved"?(s(),u(d,{key:0,theme:"success"},{default:t(()=>[...e[27]||(e[27]=[o("通过",-1)])]),_:1})):n.value.approvalStatus==="rejected"?(s(),u(d,{key:1,theme:"danger"},{default:t(()=>[...e[28]||(e[28]=[o("驳回",-1)])]),_:1})):(s(),u(d,{key:2,theme:"default"},{default:t(()=>[...e[29]||(e[29]=[o("待审批",-1)])]),_:1}))]),_:1}),n.value.approvalNotes?(s(),u(f,{key:0,label:"审批意见",span:2},{default:t(()=>[o(m(n.value.approvalNotes),1)]),_:1})):A("",!0),l(f,{label:"创建时间",span:2},{default:t(()=>[o(m(n.value.createdAt),1)]),_:1}),n.value.approvedAt?(s(),u(f,{key:1,label:"审批时间",span:2},{default:t(()=>[o(m(n.value.approvedAt),1)]),_:1})):A("",!0)]),_:1}),e[33]||(e[33]=_("h4",{style:{"margin-top":"20px"}},"订单明细",-1)),l(O,{data:n.value.items,columns:J,size:"small"},null,8,["data"]),n.value.status==="pending"?(s(),F("div",ie,[e[32]||(e[32]=_("h4",null,"审批操作",-1)),l(T,{modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=a=>g.value=a),placeholder:"请输入审批意见（可选）",maxlength:500,style:{"margin-top":"12px"}},null,8,["modelValue"]),l(q,{style:{"margin-top":"16px"}},{default:t(()=>[l(x,{theme:"success",onClick:e[4]||(e[4]=a=>j(n.value,!0))},{icon:t(()=>[l(i,{name:"check"})]),default:t(()=>[e[30]||(e[30]=o(" 通过 ",-1))]),_:1}),l(x,{theme:"danger",onClick:e[5]||(e[5]=a=>j(n.value,!1))},{icon:t(()=>[l(i,{name:"close"})]),default:t(()=>[e[31]||(e[31]=o(" 驳回 ",-1))]),_:1})]),_:1})])):A("",!0)])):A("",!0)]),_:1},8,["visible"]),l(E,{visible:h.value,"onUpdate:visible":e[8]||(e[8]=a=>h.value=a),header:k.value?"通过审批":"驳回订单",onConfirm:W},{default:t(()=>[_("div",pe,[_("p",ve,m(k.value?"确认通过此订单审批？":"确认驳回此订单？"),1),l(T,{modelValue:g.value,"onUpdate:modelValue":e[7]||(e[7]=a=>g.value=a),placeholder:k.value?"请输入审批意见（可选）":"请输入驳回理由",maxlength:500},null,8,["modelValue","placeholder"])])]),_:1},8,["visible","header"])])}}}),ye=ne(me,[["__scopeId","data-v-4ac2b78e"]]);export{ye as default};
