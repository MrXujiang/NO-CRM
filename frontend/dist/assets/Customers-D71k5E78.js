import{c as x}from"./customer-C3qg_G_a.js";import{C as I,d as _e,r as m,l as ge,b as s,c as g,e as U,h as t,w as a,i as u,o as p,F as E,f as O,p as L,t as v,m as R,M as d,_ as he}from"./index-BQBF81MK.js";const ye={async uploadSingle(c){const h=new FormData;return h.append("file",c),{...await I.post("/upload/single",h,{headers:{"Content-Type":"multipart/form-data"}}),uploadedAt:new Date().toISOString()}},async uploadMultiple(c){const h=new FormData;return c.forEach(w=>{h.append("files",w)}),(await I.post("/upload/multiple",h,{headers:{"Content-Type":"multipart/form-data"}})).map(w=>({...w,uploadedAt:new Date().toISOString()}))},deleteFile(c){return I.delete("/upload/file",{data:{filename:c}})},getFileUrl(c){return c.startsWith("http"),c}},be={class:"page-container"},ke={class:"page-header"},we={class:"pagination-container"},Ve={key:0,class:"customer-detail"},Ce={key:0},xe={key:0,class:"attachments-list"},Se=["href"],Me={class:"file-size"},ze={key:1},De="/api/upload/single",Ue=_e({__name:"Customers",setup(c){const h=m([]),S=m(!1),w=m(""),M=m(!1),B=m(!1),C=m(null),i=m(null),z=m(!1),F=m(10),f=m({current:1,pageSize:10,total:0}),n=m({name:"",phone:"",company:"",source:"",tags:[],remarks:"",attachments:[]}),W=[{colKey:"name",title:"姓名",width:120},{colKey:"phone",title:"电话",width:140},{colKey:"company",title:"公司",width:150},{colKey:"source",title:"来源",width:120},{colKey:"tags",title:"标签",width:200},{colKey:"action",title:"操作",width:180,fixed:"right"}],j={Authorization:`Bearer ${localStorage.getItem("token")}`},V=async()=>{S.value=!0;try{const o=await x.getAll(w.value,f.value.current,f.value.pageSize);h.value=o.data,f.value.total=o.total}catch{d.error("加载客户列表失败")}finally{S.value=!1}},H=()=>{f.value.current=1,V()},q=()=>{V()},J=o=>{i.value=o,B.value=!0},Q=o=>{C.value=o,n.value={name:o.name,phone:o.phone,company:o.company||"",source:o.source||"",tags:o.tags||[],remarks:o.remarks||"",attachments:o.attachments?o.attachments.map(e=>({name:e.originalName,url:e.url,status:"success",response:e})):[]},M.value=!0},X=async o=>{try{await x.delete(o),d.success("删除成功"),V()}catch{d.error("删除失败")}},Y=async()=>{if(!n.value.name||!n.value.phone){d.warning("请填写必填信息");return}try{const o=n.value.attachments.filter(r=>r.status==="success"&&r.response).map(r=>({filename:r.response.filename,originalName:r.response.originalName,size:r.response.size,mimetype:r.response.mimetype,url:r.response.url,uploadedAt:r.response.uploadedAt||new Date().toISOString()})),e={...n.value,attachments:o};C.value?(await x.update(C.value.id,e),d.success("更新成功")):(await x.create(e),d.success("创建成功")),M.value=!1,V()}catch{d.error(C.value?"更新失败":"创建失败")}},Z=()=>{C.value=null,n.value={name:"",phone:"",company:"",source:"",tags:[],remarks:"",attachments:[]}},ee=o=>new Date(o).toLocaleString("zh-CN"),te=o=>{if(o===0)return"0 B";const e=1024,r=["B","KB","MB","GB"],y=Math.floor(Math.log(o)/Math.log(e));return Math.round(o/Math.pow(e,y)*100)/100+" "+r[y]},ae=o=>ye.getFileUrl(o),le=o=>o.size>10485760?(d.error("文件大小不能超过10MB"),!1):!0,oe=o=>(d.success("文件上传成功"),o),ne=o=>{const{file:e}=o;return e.response&&e.response.filename,!0},se=async()=>{try{const o=await x.generateMock(F.value);d.success(o.message),V()}catch{d.error("生成Mock数据失败")}},re=async()=>{try{const o=await x.clearMock();d.success(o.message),z.value=!1,V()}catch{d.error("清空数据失败")}},ue=()=>{z.value=!1};return ge(()=>{V()}),(o,e)=>{const r=s("t-icon"),y=s("t-input"),D=s("t-button"),A=s("t-space"),P=s("t-tag"),N=s("t-link"),T=s("t-popconfirm"),ie=s("t-table"),de=s("t-pagination"),_=s("t-form-item"),K=s("t-option"),me=s("t-select"),pe=s("t-textarea"),ce=s("t-upload"),G=s("t-form"),$=s("t-dialog"),b=s("t-descriptions-item"),ve=s("t-descriptions"),fe=s("t-input-number");return p(),g("div",be,[U("div",ke,[t(A,null,{default:a(()=>[t(y,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=l=>w.value=l),placeholder:"搜索客户（姓名、电话、公司）",clearable:"",style:{width:"300px"},onChange:H},{"prefix-icon":a(()=>[t(r,{name:"search"})]),_:1},8,["modelValue"]),t(D,{theme:"primary",onClick:e[1]||(e[1]=l=>M.value=!0)},{icon:a(()=>[t(r,{name:"add"})]),default:a(()=>[e[16]||(e[16]=u(" 新建客户 ",-1))]),_:1}),t(D,{theme:"default",onClick:e[2]||(e[2]=l=>z.value=!0)},{icon:a(()=>[t(r,{name:"tools"})]),default:a(()=>[e[17]||(e[17]=u(" Mock数据 ",-1))]),_:1})]),_:1})]),t(ie,{data:h.value,columns:W,loading:S.value,"row-key":"id",stripe:"",hover:""},{tags:a(({row:l})=>[(p(!0),g(E,null,O(l.tags,k=>(p(),L(P,{key:k,theme:"primary",variant:"light",style:{"margin-right":"4px"}},{default:a(()=>[u(v(k),1)]),_:2},1024))),128))]),action:a(({row:l})=>[t(A,null,{default:a(()=>[t(N,{theme:"primary",onClick:k=>J(l)},{default:a(()=>[...e[18]||(e[18]=[u("查看",-1)])]),_:1},8,["onClick"]),t(N,{theme:"primary",onClick:k=>Q(l)},{default:a(()=>[...e[19]||(e[19]=[u("编辑",-1)])]),_:1},8,["onClick"]),t(T,{content:"确定删除此客户吗？",onConfirm:k=>X(l.id)},{default:a(()=>[t(N,{theme:"danger"},{default:a(()=>[...e[20]||(e[20]=[u("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])]),_:2},1024)]),_:1},8,["data","loading"]),U("div",we,[t(de,{modelValue:f.value.current,"onUpdate:modelValue":e[3]||(e[3]=l=>f.value.current=l),pageSize:f.value.pageSize,"onUpdate:pageSize":e[4]||(e[4]=l=>f.value.pageSize=l),total:f.value.total,pageSizeOptions:[10,20,50,100],"show-jumper":"",onChange:q},null,8,["modelValue","pageSize","total"])]),t($,{visible:M.value,"onUpdate:visible":e[12]||(e[12]=l=>M.value=l),header:C.value?"编辑客户":"新建客户",width:"600px",onConfirm:Y,onClose:Z},{default:a(()=>[t(G,{data:n.value,"label-align":"right","label-width":80},{default:a(()=>[t(_,{label:"姓名",name:"name"},{default:a(()=>[t(y,{modelValue:n.value.name,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.name=l),placeholder:"请输入客户姓名"},null,8,["modelValue"])]),_:1}),t(_,{label:"电话",name:"phone"},{default:a(()=>[t(y,{modelValue:n.value.phone,"onUpdate:modelValue":e[6]||(e[6]=l=>n.value.phone=l),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1}),t(_,{label:"公司",name:"company"},{default:a(()=>[t(y,{modelValue:n.value.company,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.company=l),placeholder:"请输入公司名称"},null,8,["modelValue"])]),_:1}),t(_,{label:"来源",name:"source"},{default:a(()=>[t(y,{modelValue:n.value.source,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.source=l),placeholder:"如：网络推广、朋友介绍等"},null,8,["modelValue"])]),_:1}),t(_,{label:"标签",name:"tags"},{default:a(()=>[t(me,{modelValue:n.value.tags,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.tags=l),multiple:"",placeholder:"选择或输入标签",creatable:"",filterable:""},{default:a(()=>[t(K,{value:"重点客户",label:"重点客户"}),t(K,{value:"意向客户",label:"意向客户"}),t(K,{value:"老客户",label:"老客户"})]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"备注",name:"remarks"},{default:a(()=>[t(pe,{modelValue:n.value.remarks,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.remarks=l),placeholder:"请输入备注信息",autosize:{minRows:3}},null,8,["modelValue"])]),_:1}),t(_,{label:"附件",name:"attachments"},{default:a(()=>[t(ce,{modelValue:n.value.attachments,"onUpdate:modelValue":e[11]||(e[11]=l=>n.value.attachments=l),action:De,headers:j,"before-upload":le,"on-success":oe,"on-remove":ne,max:5,theme:"file-flow",accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx",tips:"支持图片、PDF、Word、Excel文件，单个文件不超过10MB，最多5个文件"},null,8,["modelValue"])]),_:1})]),_:1},8,["data"])]),_:1},8,["visible","header"]),t($,{visible:B.value,"onUpdate:visible":e[13]||(e[13]=l=>B.value=l),header:"客户详情",width:"600px",footer:!1},{default:a(()=>[i.value?(p(),g("div",Ve,[t(ve,{column:2,bordered:""},{default:a(()=>[t(b,{label:"姓名"},{default:a(()=>[u(v(i.value.name),1)]),_:1}),t(b,{label:"电话"},{default:a(()=>[u(v(i.value.phone),1)]),_:1}),t(b,{label:"公司"},{default:a(()=>[u(v(i.value.company||"-"),1)]),_:1}),t(b,{label:"来源"},{default:a(()=>[u(v(i.value.source||"-"),1)]),_:1}),t(b,{label:"标签",span:2},{default:a(()=>{var l;return[(p(!0),g(E,null,O(i.value.tags,k=>(p(),L(P,{key:k,theme:"primary",variant:"light",style:{"margin-right":"4px"}},{default:a(()=>[u(v(k),1)]),_:2},1024))),128)),(l=i.value.tags)!=null&&l.length?R("",!0):(p(),g("span",Ce,"-"))]}),_:1}),t(b,{label:"备注",span:2},{default:a(()=>[u(v(i.value.remarks||"-"),1)]),_:1}),t(b,{label:"附件",span:2},{default:a(()=>[i.value.attachments&&i.value.attachments.length>0?(p(),g("div",xe,[(p(!0),g(E,null,O(i.value.attachments,l=>(p(),g("div",{key:l.filename,class:"attachment-item"},[U("a",{href:ae(l.url),target:"_blank",class:"attachment-link"},[t(r,{name:"file"}),u(" "+v(l.originalName)+" ",1),U("span",Me,"("+v(te(l.size))+")",1)],8,Se)]))),128))])):(p(),g("span",ze,"-"))]),_:1}),t(b,{label:"创建时间",span:2},{default:a(()=>[u(v(ee(i.value.createdAt)),1)]),_:1})]),_:1})])):R("",!0)]),_:1},8,["visible"]),t($,{visible:z.value,"onUpdate:visible":e[15]||(e[15]=l=>z.value=l),header:"Mock数据管理",width:"500px",onConfirm:ue},{default:a(()=>[t(G,{"label-align":"right","label-width":100},{default:a(()=>[t(_,{label:"生成数量"},{default:a(()=>[t(fe,{modelValue:F.value,"onUpdate:modelValue":e[14]||(e[14]=l=>F.value=l),min:1,max:100,placeholder:"请输入生成数量"},null,8,["modelValue"])]),_:1}),t(_,{label:"操作"},{default:a(()=>[t(A,null,{default:a(()=>[t(D,{theme:"primary",onClick:se},{icon:a(()=>[t(r,{name:"add"})]),default:a(()=>[e[21]||(e[21]=u(" 生成Mock数据 ",-1))]),_:1}),t(T,{content:"确定清空所有客户数据吗？此操作不可恢复！",onConfirm:re},{default:a(()=>[t(D,{theme:"danger"},{icon:a(()=>[t(r,{name:"delete"})]),default:a(()=>[e[22]||(e[22]=u(" 清空所有数据 ",-1))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["visible"])])}}}),Ae=he(Ue,[["__scopeId","data-v-ce0f4dad"]]);export{Ae as default};
