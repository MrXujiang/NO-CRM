import{C as k,d as he,r as f,a as Ce,D as ee,l as Se,b as i,c as w,e as r,h as a,w as l,i as n,p as d,m as U,o,t as c,F as H,f as E,M as g,_ as Ve}from"./index-BQBF81MK.js";import{o as Ie}from"./order-kzB7aZ2c.js";import{c as Me}from"./contract-template-C-e1ZM1S.js";const h={async getAll(u,x=1,F=10){const A={page:x,pageSize:F};return u&&(A.signStatus=u),k.get("/contracts",{params:A})},async getByOrder(u){return k.get(`/contracts/order/${u}`)},async getOne(u){return k.get(`/contracts/${u}`)},async create(u){return k.post("/contracts",u)},async update(u,x){return k.patch(`/contracts/${u}`,x)},async delete(u){return k.delete(`/contracts/${u}`)},async sign(u,x){return k.post(`/contracts/${u}/sign`,x)},async validate(u){return k.post(`/contracts/${u}/validate`)},async getStatistics(){return k.get("/contracts/statistics")},async generateMock(u){return k.post("/contracts/mock/generate",{count:u})},async clearMock(){return k.delete("/contracts/mock/clear")}},Ne={class:"contracts-page"},Ue={class:"page-header"},Ae={key:0},De={style:{color:"#e34d59","font-size":"18px","font-weight":"bold"}},Re={key:0,style:{"margin-top":"20px"}},$e={key:0,style:{"margin-top":"10px"}},ze={style:{display:"flex","align-items":"center",gap:"10px"}},Te={key:1,style:{"margin-top":"20px"}},Fe={style:{"margin-top":"20px"}},Ke=["innerHTML"],Be={key:0},Oe={style:{"text-align":"center"}},je={style:{"font-size":"24px",color:"#0052d9"}},Le={style:{"text-align":"center"}},Pe={style:{"font-size":"24px",color:"#00a870"}},He={style:{"text-align":"center"}},Ee={style:{"font-size":"24px",color:"#e37318"}},Ge=he({__name:"Contracts",setup(u){const x=f(!1),F=f([]),A=f(""),K=f(!1),G=f(!1),q=f(!1),B=f(!1),O=f(!1),J=f(10),m=f(null),_=f(null),$=f(null),Q=f([]),W=f([]),te=Ce(),y=ee({orderId:"",templateId:""}),p=ee({contractId:"",signerName:"",signerType:"company",signMethod:"digital"}),C=ee({current:1,pageSize:10,total:0}),ae=[{colKey:"contractNo",title:"合同编号",width:150},{colKey:"title",title:"合同标题",width:200},{colKey:"type",title:"合同类型",width:100},{colKey:"amount",title:"合同金额",width:120,cell:"amount"},{colKey:"signStatus",title:"签署状态",width:100,cell:"signStatus"},{colKey:"validationResult",title:"风险等级",width:100,cell:"validationResult"},{colKey:"createdAt",title:"创建时间",width:150},{colKey:"action",title:"操作",width:220,cell:"action",fixed:"right"}],S=async()=>{x.value=!0;try{const s=await h.getAll(A.value||void 0,C.current,C.pageSize);F.value=s.data,C.total=s.total}catch{g.error("加载合同列表失败")}finally{x.value=!1}},ne=()=>{S()},oe=async()=>{try{const[s,e]=await Promise.all([Ie.getAll("approved",void 0,1,100),Me.getAll(void 0,1,100)]);if(Q.value=s.data||[],W.value=e.data||[],Q.value.length===0){g.warning("没有可用的已审批订单，请先创建订单并审批通过");return}if(W.value.length===0){g.warning("没有可用的合同模板，请先创建模板");return}y.orderId="",y.templateId="",B.value=!0}catch{g.error("加载数据失败")}},se=async()=>{var s,e;if(!y.orderId||!y.templateId){g.warning("请选择订单和模板");return}try{await h.create({orderId:y.orderId,templateId:y.templateId}),g.success("合同生成成功"),B.value=!1,S()}catch(b){g.error(((e=(s=b.response)==null?void 0:s.data)==null?void 0:e.message)||"合同生成失败")}},ie=s=>{m.value=s,_.value=s.validationResult,G.value=!0},re=async s=>{var e;try{const b=await h.validate(s);if(_.value=b,g.success("风险校验完成"),((e=m.value)==null?void 0:e.id)===s){const V=await h.getOne(s);m.value=V}S()}catch{g.error("风险校验失败")}},de=s=>{var e;p.contractId=s.id,p.signerName=((e=te.user)==null?void 0:e.name)||"",p.signerType="company",p.signMethod="digital",O.value=!0},ue=async()=>{var s,e,b,V;if(!p.signerName){g.warning("请输入签署人姓名");return}try{if(await h.sign(p.contractId,{signerId:((s=te.user)==null?void 0:s.id)||"",signerName:p.signerName,signerType:p.signerType,signMethod:p.signMethod}),g.success("签署成功"),O.value=!1,S(),((e=m.value)==null?void 0:e.id)===p.contractId){const I=await h.getOne(p.contractId);m.value=I}}catch(I){g.error(((V=(b=I.response)==null?void 0:b.data)==null?void 0:V.message)||"签署失败")}},me=async s=>{try{await h.delete(s),g.success("删除成功"),S()}catch{g.error("删除失败")}},pe=async()=>{try{const s=await h.generateMock(J.value);g.success(s.message),K.value=!1,S()}catch{g.error("生成Mock数据失败")}},ce=async()=>{try{$.value=await h.getStatistics(),q.value=!0}catch{g.error("加载统计数据失败")}};return Se(()=>{S()}),(s,e)=>{const b=i("t-icon"),V=i("t-button"),I=i("t-space"),M=i("t-option"),X=i("t-select"),z=i("t-card"),v=i("t-tag"),j=i("t-link"),ge=i("t-popconfirm"),ve=i("t-table"),fe=i("t-pagination"),_e=i("t-input-number"),D=i("t-form-item"),L=i("t-alert"),Y=i("t-form"),T=i("t-dialog"),N=i("t-descriptions-item"),ye=i("t-descriptions"),be=i("t-timeline-item"),ke=i("t-timeline"),Z=i("t-col"),we=i("t-row"),xe=i("t-input"),P=i("t-radio"),le=i("t-radio-group");return o(),w("div",Ne,[r("div",Ue,[e[17]||(e[17]=r("h2",null,"合同管理",-1)),a(I,null,{default:l(()=>[a(V,{theme:"default",onClick:e[0]||(e[0]=t=>K.value=!0)},{icon:l(()=>[a(b,{name:"data"})]),default:l(()=>[e[15]||(e[15]=n(" Mock数据 ",-1))]),_:1}),a(V,{theme:"primary",onClick:oe},{icon:l(()=>[a(b,{name:"add"})]),default:l(()=>[e[16]||(e[16]=n(" 新建合同 ",-1))]),_:1})]),_:1})]),a(z,{class:"filter-card"},{default:l(()=>[a(I,null,{default:l(()=>[a(X,{modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=t=>A.value=t),placeholder:"签署状态",clearable:"",style:{width:"150px"},onChange:S},{default:l(()=>[a(M,{value:"not_started",label:"未开始"}),a(M,{value:"pending",label:"待签署"}),a(M,{value:"partial",label:"部分签署"}),a(M,{value:"signed",label:"已签署"}),a(M,{value:"rejected",label:"已拒签"})]),_:1},8,["modelValue"]),a(V,{theme:"default",onClick:ce},{icon:l(()=>[a(b,{name:"chart-pie"})]),default:l(()=>[e[18]||(e[18]=n(" 查看统计 ",-1))]),_:1})]),_:1})]),_:1}),a(ve,{data:F.value,columns:ae,loading:x.value,"row-key":"id",stripe:"",hover:"",class:"data-table"},{signStatus:l(({row:t})=>[t.signStatus==="not_started"?(o(),d(v,{key:0,theme:"default"},{default:l(()=>[...e[19]||(e[19]=[n("未开始",-1)])]),_:1})):t.signStatus==="pending"?(o(),d(v,{key:1,theme:"warning"},{default:l(()=>[...e[20]||(e[20]=[n("待签署",-1)])]),_:1})):t.signStatus==="partial"?(o(),d(v,{key:2,theme:"primary"},{default:l(()=>[...e[21]||(e[21]=[n("部分签署",-1)])]),_:1})):t.signStatus==="signed"?(o(),d(v,{key:3,theme:"success"},{default:l(()=>[...e[22]||(e[22]=[n("已签署",-1)])]),_:1})):t.signStatus==="rejected"?(o(),d(v,{key:4,theme:"danger"},{default:l(()=>[...e[23]||(e[23]=[n("已拒签",-1)])]),_:1})):(o(),d(v,{key:5},{default:l(()=>[n(c(t.signStatus),1)]),_:2},1024))]),amount:l(({row:t})=>{var R;return[n(" ¥"+c((R=t.amount)==null?void 0:R.toFixed(2)),1)]}),validationResult:l(({row:t})=>[t.validationResult?t.validationResult.level==="safe"?(o(),d(v,{key:1,theme:"success"},{default:l(()=>[...e[25]||(e[25]=[n("安全",-1)])]),_:1})):t.validationResult.level==="warning"?(o(),d(v,{key:2,theme:"warning"},{default:l(()=>[...e[26]||(e[26]=[n("警告",-1)])]),_:1})):t.validationResult.level==="danger"?(o(),d(v,{key:3,theme:"danger"},{default:l(()=>[...e[27]||(e[27]=[n("危险",-1)])]),_:1})):U("",!0):(o(),d(v,{key:0,theme:"default"},{default:l(()=>[...e[24]||(e[24]=[n("未校验",-1)])]),_:1}))]),action:l(({row:t})=>[a(I,null,{default:l(()=>[a(j,{theme:"primary",onClick:R=>ie(t)},{default:l(()=>[...e[28]||(e[28]=[n("查看",-1)])]),_:1},8,["onClick"]),a(j,{onClick:R=>re(t.id)},{default:l(()=>[...e[29]||(e[29]=[n("校验风险",-1)])]),_:1},8,["onClick"]),t.signStatus!=="signed"?(o(),d(j,{key:0,onClick:R=>de(t)},{default:l(()=>[...e[30]||(e[30]=[n("签署",-1)])]),_:1},8,["onClick"])):U("",!0),t.status==="draft"?(o(),d(ge,{key:1,content:"确认删除此合同？",onConfirm:R=>me(t.id)},{default:l(()=>[a(j,{theme:"danger"},{default:l(()=>[...e[31]||(e[31]=[n("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])):U("",!0)]),_:2},1024)]),_:1},8,["data","loading"]),a(fe,{modelValue:C.current,"onUpdate:modelValue":e[2]||(e[2]=t=>C.current=t),pageSize:C.pageSize,"onUpdate:pageSize":e[3]||(e[3]=t=>C.pageSize=t),total:C.total,"show-jumper":"",onChange:ne},null,8,["modelValue","pageSize","total"]),a(T,{visible:K.value,"onUpdate:visible":e[5]||(e[5]=t=>K.value=t),header:"生成 Mock 数据",onConfirm:pe},{default:l(()=>[a(Y,null,{default:l(()=>[a(D,{label:"生成数量"},{default:l(()=>[a(_e,{modelValue:J.value,"onUpdate:modelValue":e[4]||(e[4]=t=>J.value=t),min:1,max:100},null,8,["modelValue"])]),_:1}),a(L,{theme:"info",message:"提示：生成合同前请确保已有订单和模板数据"})]),_:1})]),_:1},8,["visible"]),a(T,{visible:G.value,"onUpdate:visible":e[6]||(e[6]=t=>G.value=t),header:"合同详情",width:"900px"},{default:l(()=>[m.value?(o(),w("div",Ae,[a(ye,{column:2,bordered:""},{default:l(()=>[a(N,{label:"合同编号"},{default:l(()=>[n(c(m.value.contractNo),1)]),_:1}),a(N,{label:"签署状态"},{default:l(()=>[m.value.signStatus==="not_started"?(o(),d(v,{key:0,theme:"default"},{default:l(()=>[...e[32]||(e[32]=[n("未开始",-1)])]),_:1})):m.value.signStatus==="signed"?(o(),d(v,{key:1,theme:"success"},{default:l(()=>[...e[33]||(e[33]=[n("已签署",-1)])]),_:1})):(o(),d(v,{key:2,theme:"warning"},{default:l(()=>[n(c(m.value.signStatus),1)]),_:1}))]),_:1}),a(N,{label:"合同标题",span:2},{default:l(()=>[n(c(m.value.title),1)]),_:1}),a(N,{label:"合同金额",span:2},{default:l(()=>{var t;return[r("span",De," ¥"+c((t=m.value.amount)==null?void 0:t.toFixed(2)),1)]}),_:1}),a(N,{label:"开始日期"},{default:l(()=>[n(c(m.value.startDate),1)]),_:1}),a(N,{label:"结束日期"},{default:l(()=>[n(c(m.value.endDate),1)]),_:1}),a(N,{label:"创建时间",span:2},{default:l(()=>[n(c(m.value.createdAt),1)]),_:1})]),_:1}),_.value?(o(),w("div",Re,[e[34]||(e[34]=r("h4",null,"风险校验结果",-1)),a(L,{theme:_.value.level==="safe"?"success":_.value.level==="warning"?"warning":"error",message:`风险等级: ${_.value.level==="safe"?"安全":_.value.level==="warning"?"警告":"危险"} | 评分: ${_.value.score}分`},null,8,["theme","message"]),_.value.issues&&_.value.issues.length>0?(o(),w("div",$e,[(o(!0),w(H,null,E(_.value.issues,t=>(o(),d(z,{key:t.id,style:{"margin-bottom":"8px"}},{default:l(()=>[r("div",ze,[a(v,{theme:t.level==="high"?"danger":t.level==="medium"?"warning":"default",size:"small"},{default:l(()=>[n(c(t.level==="high"?"高风险":t.level==="medium"?"中风险":"低风险"),1)]),_:2},1032,["theme"]),r("span",null,c(t.message),1)])]),_:2},1024))),128))])):(o(),d(L,{key:1,theme:"success",message:"未发现风险问题",style:{"margin-top":"10px"}}))])):U("",!0),m.value.signRecords&&m.value.signRecords.length>0?(o(),w("div",Te,[e[35]||(e[35]=r("h4",null,"签署记录",-1)),a(ke,null,{default:l(()=>[(o(!0),w(H,null,E(m.value.signRecords,t=>(o(),d(be,{key:t.id},{default:l(()=>[r("strong",null,c(t.signerName),1),n(" ("+c(t.signerRole==="party_a"?"甲方":"乙方")+") 于 "+c(t.signedAt)+" 完成签署 ",1)]),_:2},1024))),128))]),_:1})])):U("",!0),r("div",Fe,[e[36]||(e[36]=r("h4",null,"合同内容",-1)),r("div",{style:{border:"1px solid #ddd",padding:"20px","border-radius":"4px",background:"#fafafa","max-height":"400px","overflow-y":"auto"},innerHTML:m.value.content},null,8,Ke)])])):U("",!0)]),_:1},8,["visible"]),a(T,{visible:q.value,"onUpdate:visible":e[7]||(e[7]=t=>q.value=t),header:"合同统计",width:"600px"},{default:l(()=>[$.value?(o(),w("div",Be,[a(we,{gutter:16},{default:l(()=>[a(Z,{span:8},{default:l(()=>[a(z,null,{default:l(()=>[r("div",Oe,[r("div",je,c($.value.total),1),e[37]||(e[37]=r("div",{style:{color:"#888"}},"合同总数",-1))])]),_:1})]),_:1}),a(Z,{span:8},{default:l(()=>[a(z,null,{default:l(()=>{var t;return[r("div",Le,[r("div",Pe,"¥"+c((t=$.value.totalAmount)==null?void 0:t.toFixed(0)),1),e[38]||(e[38]=r("div",{style:{color:"#888"}},"合同总额",-1))])]}),_:1})]),_:1}),a(Z,{span:8},{default:l(()=>[a(z,null,{default:l(()=>{var t;return[r("div",He,[r("div",Ee,"¥"+c((t=$.value.avgAmount)==null?void 0:t.toFixed(0)),1),e[39]||(e[39]=r("div",{style:{color:"#888"}},"平均金额",-1))])]}),_:1})]),_:1})]),_:1})])):U("",!0)]),_:1},8,["visible"]),a(T,{visible:B.value,"onUpdate:visible":e[10]||(e[10]=t=>B.value=t),header:"创建合同",width:"600px",onConfirm:se},{default:l(()=>[a(Y,{data:y,"label-width":"100px"},{default:l(()=>[a(D,{label:"订单"},{default:l(()=>[a(X,{modelValue:y.orderId,"onUpdate:modelValue":e[8]||(e[8]=t=>y.orderId=t),placeholder:"请选择订单",filterable:""},{default:l(()=>[(o(!0),w(H,null,E(Q.value,t=>(o(),d(M,{key:t.id,value:t.id,label:t.orderNo+" - "+t.title},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(D,{label:"合同模板"},{default:l(()=>[a(X,{modelValue:y.templateId,"onUpdate:modelValue":e[9]||(e[9]=t=>y.templateId=t),placeholder:"请选择模板",filterable:""},{default:l(()=>[(o(!0),w(H,null,E(W.value,t=>(o(),d(M,{key:t.id,value:t.id,label:t.name},null,8,["value","label"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(L,{theme:"info",message:"提示：合同将基于选定的订单和模板自动生成"})]),_:1},8,["data"])]),_:1},8,["visible"]),a(T,{visible:O.value,"onUpdate:visible":e[14]||(e[14]=t=>O.value=t),header:"签署合同",width:"500px",onConfirm:ue},{default:l(()=>[a(Y,{data:p,"label-width":"100px"},{default:l(()=>[a(D,{label:"签署人姓名"},{default:l(()=>[a(xe,{modelValue:p.signerName,"onUpdate:modelValue":e[11]||(e[11]=t=>p.signerName=t),placeholder:"请输入签署人姓名"},null,8,["modelValue"])]),_:1}),a(D,{label:"签署方"},{default:l(()=>[a(le,{modelValue:p.signerType,"onUpdate:modelValue":e[12]||(e[12]=t=>p.signerType=t)},{default:l(()=>[a(P,{value:"company"},{default:l(()=>[...e[40]||(e[40]=[n("公司（甲方）",-1)])]),_:1}),a(P,{value:"customer"},{default:l(()=>[...e[41]||(e[41]=[n("客户（乙方）",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(D,{label:"签署方式"},{default:l(()=>[a(le,{modelValue:p.signMethod,"onUpdate:modelValue":e[13]||(e[13]=t=>p.signMethod=t)},{default:l(()=>[a(P,{value:"digital"},{default:l(()=>[...e[42]||(e[42]=[n("电子签名",-1)])]),_:1}),a(P,{value:"handwritten"},{default:l(()=>[...e[43]||(e[43]=[n("手写签名",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["data"])]),_:1},8,["visible"])])}}}),We=Ve(Ge,[["__scopeId","data-v-82c56150"]]);export{We as default};
