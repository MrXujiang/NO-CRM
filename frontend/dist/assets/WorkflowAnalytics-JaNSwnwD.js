import{d as Z,u as tt,r as v,D as K,l as et,b as c,c as x,e as s,h as a,w as t,i as _,t as r,p as f,o as u,F as at,f as st,x as nt,M as ot,_ as it}from"./index-BQBF81MK.js";import{w as N}from"./workflow-C3Hchb8L.js";import{i as S}from"./index-CGdFOYoS.js";const lt={class:"workflow-analytics-page"},ct={class:"page-header"},rt={class:"metric-content"},dt={class:"metric-data"},ut={class:"metric-value"},mt={class:"metric-content"},pt={class:"metric-data"},_t={class:"metric-value"},ft={class:"metric-content"},vt={class:"metric-data"},gt={class:"metric-value"},yt={class:"metric-content"},ht={class:"metric-data"},kt={class:"metric-value"},wt={class:"metric-content"},bt={class:"metric-data"},xt={class:"metric-value"},Dt={class:"metric-content"},Ct={class:"metric-data"},Rt={class:"metric-value"},It={class:"metric-content"},Tt={class:"metric-data"},At={class:"metric-value"},St={style:{color:"#666","margin-top":"4px"}},zt={key:0},Bt={key:1},Kt={key:2},Nt=Z({__name:"WorkflowAnalytics",setup(Vt){const V=tt(),R=v(!1),z=v([]),d=K({totalInstances:0,runningInstances:0,completedInstances:0,rejectedInstances:0,avgDuration:0,approvalRate:0,myPendingTasks:0,byStatus:[],byBusinessType:[]}),w=v([]),B=v([]),b=K({current:1,pageSize:10,total:0}),I=v(),T=v(),A=v();let g=null,y=null,h=null;const M=[{colKey:"workflowName",title:"工作流",width:150},{colKey:"businessType",title:"业务类型",width:100},{colKey:"businessTitle",title:"业务标题",width:200},{colKey:"initiatorName",title:"发起人",width:100},{colKey:"status",title:"状态",width:100,cell:"status"},{colKey:"startedAt",title:"开始时间",width:160},{colKey:"duration",title:"耗时",width:100,cell:"duration"},{colKey:"action",title:"操作",width:100,cell:"action",fixed:"right"}],D=async()=>{var i,e;R.value=!0;try{const o=await N.getStatistics();Object.assign(d,o);const l=await N.getInstances(b.current,b.pageSize);B.value=l.data,b.total=l.total,E(),await nt(),j()}catch(o){ot.error(((e=(i=o.response)==null?void 0:i.data)==null?void 0:e.message)||"加载失败")}finally{R.value=!1}},j=()=>{O(),P(),L()},O=()=>{if(!I.value)return;g||(g=S(I.value));const i={running:"运行中",pending:"等待处理",completed:"已完成",rejected:"已驳回",cancelled:"已取消"},e={tooltip:{trigger:"item",formatter:"{b}: {c} ({d}%)"},legend:{orient:"vertical",right:10,top:"center"},series:[{type:"pie",radius:["40%","70%"],center:["40%","50%"],data:d.byStatus.map(o=>({value:o.count,name:i[o.status]||o.status})),emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};g.setOption(e)},P=()=>{if(!T.value)return;y||(y=S(T.value));const i={order:"订单",contract:"合同",customer:"客户",lead:"线索"},e={tooltip:{trigger:"item",formatter:"{b}: {c}"},xAxis:{type:"category",data:d.byBusinessType.map(o=>i[o.type]||o.type)},yAxis:{type:"value"},series:[{type:"bar",data:d.byBusinessType.map(o=>o.count),itemStyle:{color:"#0052d9"}}]};y.setOption(e)},L=()=>{if(!A.value)return;h||(h=S(A.value));const l={tooltip:{trigger:"axis"},legend:{data:["完成数量","平均耗时(分钟)"]},xAxis:{type:"category",data:["周一","周二","周三","周四","周五","周六","周日"]},yAxis:[{type:"value",name:"完成数量",position:"left"},{type:"value",name:"平均耗时(分钟)",position:"right"}],series:[{name:"完成数量",type:"line",data:[12,18,15,22,19,25,20],smooth:!0,itemStyle:{color:"#00a870"}},{name:"平均耗时(分钟)",type:"line",yAxisIndex:1,data:[45,42,48,40,38,35,37],smooth:!0,itemStyle:{color:"#0052d9"}}]};h.setOption(l)},E=()=>{w.value=[],d.avgDuration>60&&w.value.push({nodeId:"approval1",nodeName:"主管审批",avgDuration:75,timeoutRate:15,suggestion:"建议增加审批人员或优化审批流程"}),d.approvalRate<80&&w.value.push({nodeId:"approval2",nodeName:"总监审批",avgDuration:120,timeoutRate:25,suggestion:"驳回率较高，建议优化前置审批条件"})},F=i=>{const e=new Date(i).getTime(),o=new Date().getTime();return Math.round((o-e)/6e4)},W=i=>{b.current=i.current,D()},$=i=>{V.push(`/workflow-instances/${i.id}`)};return et(()=>{D(),window.addEventListener("resize",()=>{g==null||g.resize(),y==null||y.resize(),h==null||h.resize()})}),(i,e)=>{const o=c("t-range-input-popup"),l=c("t-icon"),q=c("t-button"),U=c("t-space"),m=c("t-card"),p=c("t-col"),C=c("t-row"),X=c("t-alert"),k=c("t-tag"),G=c("t-list-item-meta"),H=c("t-list-item"),J=c("t-list"),Q=c("t-link"),Y=c("t-table");return u(),x("div",lt,[s("div",ct,[e[2]||(e[2]=s("h2",null,"工作流分析",-1)),a(U,null,{default:t(()=>[a(o,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=n=>z.value=n),clearable:"",onChange:D},null,8,["modelValue"]),a(q,{theme:"primary",onClick:D},{icon:t(()=>[a(l,{name:"refresh"})]),default:t(()=>[e[1]||(e[1]=_(" 刷新数据 ",-1))]),_:1})]),_:1})]),a(C,{gutter:16,class:"metrics-row"},{default:t(()=>[a(p,{span:3},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",rt,[a(l,{name:"layers",class:"metric-icon primary"}),s("div",dt,[s("div",ut,r(d.totalInstances||0),1),e[3]||(e[3]=s("div",{class:"metric-label"},"总流程数",-1))])])]),_:1})]),_:1}),a(p,{span:3},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",mt,[a(l,{name:"time",class:"metric-icon warning"}),s("div",pt,[s("div",_t,r(d.runningInstances||0),1),e[4]||(e[4]=s("div",{class:"metric-label"},"运行中",-1))])])]),_:1})]),_:1}),a(p,{span:3},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",ft,[a(l,{name:"check-circle",class:"metric-icon success"}),s("div",vt,[s("div",gt,r(d.completedInstances||0),1),e[5]||(e[5]=s("div",{class:"metric-label"},"已完成",-1))])])]),_:1})]),_:1}),a(p,{span:3},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",yt,[a(l,{name:"error-circle",class:"metric-icon danger"}),s("div",ht,[s("div",kt,r(d.rejectedInstances||0),1),e[6]||(e[6]=s("div",{class:"metric-label"},"已驳回",-1))])])]),_:1})]),_:1})]),_:1}),a(C,{gutter:16,class:"metrics-row"},{default:t(()=>[a(p,{span:4},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",wt,[a(l,{name:"dashboard",class:"metric-icon info"}),s("div",bt,[s("div",xt,r(d.avgDuration||0)+"分",1),e[7]||(e[7]=s("div",{class:"metric-label"},"平均耗时",-1))])])]),_:1})]),_:1}),a(p,{span:4},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",Dt,[a(l,{name:"chart-pie",class:"metric-icon success"}),s("div",Ct,[s("div",Rt,r(d.approvalRate||0)+"%",1),e[8]||(e[8]=s("div",{class:"metric-label"},"通过率",-1))])])]),_:1})]),_:1}),a(p,{span:4},{default:t(()=>[a(m,{class:"metric-card"},{default:t(()=>[s("div",It,[a(l,{name:"queue",class:"metric-icon warning"}),s("div",Tt,[s("div",At,r(d.myPendingTasks||0),1),e[9]||(e[9]=s("div",{class:"metric-label"},"我的待办",-1))])])]),_:1})]),_:1})]),_:1}),a(C,{gutter:16,class:"charts-row"},{default:t(()=>[a(p,{span:6},{default:t(()=>[a(m,{title:"流程状态分布",class:"chart-card"},{default:t(()=>[s("div",{ref_key:"statusChartRef",ref:I,class:"chart-container"},null,512)]),_:1})]),_:1}),a(p,{span:6},{default:t(()=>[a(m,{title:"业务类型分布",class:"chart-card"},{default:t(()=>[s("div",{ref_key:"typeChartRef",ref:T,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),a(C,{gutter:16,class:"charts-row"},{default:t(()=>[a(p,{span:12},{default:t(()=>[a(m,{title:"流程效率趋势",class:"chart-card"},{default:t(()=>[s("div",{ref_key:"trendChartRef",ref:A,class:"chart-container-large"},null,512)]),_:1})]),_:1})]),_:1}),a(m,{title:"流程瓶颈分析",class:"bottleneck-card"},{default:t(()=>[w.value.length===0?(u(),f(X,{key:0,theme:"success",message:"暂无流程瓶颈，运行良好！"})):(u(),f(J,{key:1,split:!0},{default:t(()=>[(u(!0),x(at,null,st(w.value,n=>(u(),f(H,{key:n.nodeId},{default:t(()=>[a(G,null,{avatar:t(()=>[a(l,{name:"error-circle",size:"24px",style:{color:"#e34d59"}})]),title:t(()=>[s("strong",null,r(n.nodeName),1),a(k,{theme:"danger",size:"small",style:{"margin-left":"8px"}},{default:t(()=>[...e[10]||(e[10]=[_("瓶颈节点",-1)])]),_:1})]),description:t(()=>[s("div",null,"平均处理时长: "+r(n.avgDuration)+"分钟 | 超时率: "+r(n.timeoutRate)+"%",1),s("div",St,"建议: "+r(n.suggestion),1)]),_:2},1024)]),_:2},1024))),128))]),_:1}))]),_:1}),a(m,{title:"流程详细数据",class:"data-card"},{default:t(()=>[a(Y,{data:B.value,columns:M,loading:R.value,"row-key":"id",stripe:"",hover:"",pagination:b,onPageChange:W},{status:t(({row:n})=>[n.status==="running"?(u(),f(k,{key:0,theme:"primary"},{default:t(()=>[...e[11]||(e[11]=[_("运行中",-1)])]),_:1})):n.status==="pending"?(u(),f(k,{key:1,theme:"warning"},{default:t(()=>[...e[12]||(e[12]=[_("等待处理",-1)])]),_:1})):n.status==="completed"?(u(),f(k,{key:2,theme:"success"},{default:t(()=>[...e[13]||(e[13]=[_("已完成",-1)])]),_:1})):n.status==="rejected"?(u(),f(k,{key:3,theme:"danger"},{default:t(()=>[...e[14]||(e[14]=[_("已驳回",-1)])]),_:1})):(u(),f(k,{key:4},{default:t(()=>[_(r(n.status),1)]),_:2},1024))]),duration:t(({row:n})=>[n.duration?(u(),x("span",zt,r(n.duration)+"分钟",1)):n.status==="running"||n.status==="pending"?(u(),x("span",Bt,r(F(n.startedAt))+"分钟 ",1)):(u(),x("span",Kt,"-"))]),action:t(({row:n})=>[a(Q,{theme:"primary",onClick:Mt=>$(n)},{default:t(()=>[...e[15]||(e[15]=[_("查看详情",-1)])]),_:1},8,["onClick"])]),_:1},8,["data","loading","pagination"])]),_:1})])}}}),Lt=it(Nt,[["__scopeId","data-v-cf60495a"]]);export{Lt as default};
