import{o as q}from"./order-kzB7aZ2c.js";import{p as Pe}from"./product-DNZ9AZQV.js";import{c as Ne}from"./customer-C3qg_G_a.js";import{w as ie}from"./workflow-C3Hchb8L.js";import{d as Fe,r as k,D as ue,l as Te,b as m,c as P,e as s,h as o,w as l,i as d,p as v,m as D,o as u,t as c,F as ee,f as te,M as p,_ as $e}from"./index-BQBF81MK.js";let E;const Me=new Uint8Array(16);function Re(){if(!E&&(E=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!E))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return E(Me)}const b=[];for(let i=0;i<256;++i)b.push((i+256).toString(16).slice(1));function je(i,r=0){return b[i[r+0]]+b[i[r+1]]+b[i[r+2]]+b[i[r+3]]+"-"+b[i[r+4]]+b[i[r+5]]+"-"+b[i[r+6]]+b[i[r+7]]+"-"+b[i[r+8]]+b[i[r+9]]+"-"+b[i[r+10]]+b[i[r+11]]+b[i[r+12]]+b[i[r+13]]+b[i[r+14]]+b[i[r+15]]}const Oe=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),re={randomUUID:Oe};function Be(i,r,G){if(re.randomUUID&&!i)return re.randomUUID();i=i||{};const C=i.random||(i.rng||Re)();return C[6]=C[6]&15|64,C[8]=C[8]&63|128,je(C)}const Ee={class:"orders-page"},Ge={class:"page-header"},We={key:0},He={style:{color:"#e34d59","font-size":"18px","font-weight":"bold"}},Le={key:0,style:{"margin-top":"20px"}},Je={style:{"margin-top":"10px"}},Qe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Xe={style:{color:"#888","font-size":"12px"}},Ye={style:{color:"#0052d9","font-size":"12px"}},Ze={style:{display:"flex","justify-content":"space-between"}},et={style:{color:"#999","font-size":"12px"}},tt={style:{"margin-bottom":"16px"}},lt={class:"order-items-container"},ot={style:{display:"flex","justify-content":"space-between"}},nt={style:{color:"#0052d9","font-size":"12px"}},at={style:{"font-size":"16px"}},st={style:{"font-size":"18px",color:"#e34d59","font-weight":"bold"}},dt={key:0},it={style:{"text-align":"center"}},ut={style:{"font-size":"24px",color:"#0052d9"}},rt={style:{"text-align":"center"}},mt={style:{"font-size":"24px",color:"#00a870"}},ct={style:{"text-align":"center"}},pt={style:{"font-size":"24px",color:"#e37318"}},ft=Fe({__name:"Orders",setup(i){const r=k(!1),G=k([]),C=k(""),R=k(!1),W=k(!1),j=k(!1),H=k(!1),L=k(10),J=k("create"),V=k(null),Q=k([]),F=k(null),T=k([]),$=k([]),a=ue({title:"",customerId:"",description:"",items:[],discount:0,paymentTerms:"30天内付款",requireApproval:!1,notes:""}),I=ue({current:1,pageSize:10,total:0}),me=[{colKey:"orderNo",title:"订单编号",width:150},{colKey:"title",title:"订单标题",width:200},{colKey:"stage",title:"阶段",width:100},{colKey:"totalAmount",title:"订单金额",width:120,cell:"totalAmount"},{colKey:"status",title:"状态",width:100,cell:"status"},{colKey:"orderDate",title:"下单日期",width:150},{colKey:"action",title:"操作",width:280,cell:"action",fixed:"right"}],ce=[{colKey:"productName",title:"产品名称"},{colKey:"quantity",title:"数量"},{colKey:"unit",title:"单位"},{colKey:"unitPrice",title:"单价"},{colKey:"amount",title:"小计"}],pe=[{colKey:"productId",title:"产品",width:280,cell:"productId"},{colKey:"quantity",title:"数量",width:120,cell:"quantity"},{colKey:"unit",title:"单位",width:80},{colKey:"unitPrice",title:"单价",width:120,cell:"unitPrice"},{colKey:"discount",title:"折扣",width:120,cell:"discount"},{colKey:"amount",title:"小计",width:120,cell:"amount"},{colKey:"action",title:"操作",width:100,cell:"action",fixed:"right"}],fe={title:[{required:!0,message:"请输入订单标题"}],customerId:[{required:!0,message:"请选择客户"}],paymentTerms:[{required:!0,message:"请输入付款条款"}]},K=async()=>{r.value=!0;try{const n=await q.getAll(C.value||void 0,void 0,I.current,I.pageSize);G.value=n.data,I.total=n.total}catch{p.error("加载订单列表失败")}finally{r.value=!1}},ve=()=>{K()},ye=async()=>{var n,e;J.value="create",Object.assign(a,{title:"",customerId:"",description:"",items:[],discount:0,paymentTerms:"30天内付款",requireApproval:!1,notes:""});try{r.value=!0;const[y,_]=await Promise.all([Ne.getAll(void 0,1,100),Pe.getActive()]);if(T.value=y.data||[],$.value=_||[],T.value.length===0){p.warning("暂无客户数据，请先创建客户");return}if($.value.length===0){p.warning("暂无产品数据，请先创建产品");return}j.value=!0}catch(y){p.error(((e=(n=y.response)==null?void 0:n.data)==null?void 0:e.message)||"加载数据失败"),console.error("加载数据失败:",y)}finally{r.value=!1}},_e=n=>{p.info("编辑订单功能开发中...")},ge=async()=>{var n,e,y,_;if(a.items.length===0){p.warning("请至少添加一个产品");return}try{const A={customerId:a.customerId,title:a.title,description:a.description,items:a.items.map(g=>({id:g.id,productId:g.productId,productName:g.productName,productCode:g.productCode,quantity:g.quantity,unit:g.unit,unitPrice:g.unitPrice,discount:g.discount,amount:g.amount,notes:g.notes})),discount:a.discount,paymentTerms:a.paymentTerms,requireApproval:a.requireApproval,notes:a.notes};let x;if(J.value==="create"?(x=await q.create(A),p.success("订单创建成功")):(await q.update(a.id,A),p.success("订单更新成功")),a.requireApproval&&x)try{const z=(await ie.getDefinitions(1,100,"approval","published")).data.find(h=>h.code==="order_approval"||h.name.includes("订单审批"));z?(await ie.startWorkflow(z.id,{businessType:"order",businessId:x.id,businessData:{orderNo:x.orderNo,title:x.title,totalAmount:oe(),customerId:a.customerId}}),p.success("订单已提交审批")):p.warning("未找到订单审批流程，请先配置工作流")}catch(g){p.warning("启动审批流程失败: "+(((e=(n=g.response)==null?void 0:n.data)==null?void 0:e.message)||g.message))}j.value=!1,K()}catch(A){p.error(((_=(y=A.response)==null?void 0:y.data)==null?void 0:_.message)||"保存失败")}},be=()=>{a.items.push({id:Be(),productId:"",productName:"",productCode:"",quantity:1,unit:"",unitPrice:0,discount:0,amount:0})},xe=n=>{a.items.splice(n,1)},he=(n,e)=>{const y=$.value.find(_=>_.id===n);if(y){const _=a.items[e];_.productName=y.name,_.productCode=y.code,_.unit=y.unit,_.unitPrice=y.price,O(_)}},O=n=>{n.amount=n.quantity*n.unitPrice-(n.discount||0)},le=()=>a.items.reduce((n,e)=>n+(e.amount||0),0),oe=()=>Math.max(0,le()-(a.discount||0)),ke=async n=>{V.value=n,W.value=!0;try{Q.value=await q.getRecommendations(n.id)}catch(e){console.error("加载推荐失败",e)}},Ve=async n=>{try{await q.submit(n),p.success("提交成功"),K()}catch{p.error("提交失败")}},we=async n=>{try{await q.delete(n),p.success("删除成功"),K()}catch{p.error("删除失败")}},Ce=n=>{p.info("生成合同功能请前往合同管理页面")},Ue=n=>{p.success(`已添加推荐产品: ${n.name}`)},Ie=async()=>{try{const n=await q.generateMock(L.value);p.success(n.message),R.value=!1,K()}catch{p.error("生成Mock数据失败")}},Ae=async()=>{try{F.value=await q.getStatistics(),H.value=!0}catch{p.error("加载统计数据失败")}};return Te(()=>{K()}),(n,e)=>{const y=m("t-icon"),_=m("t-button"),A=m("t-space"),x=m("t-option"),g=m("t-select"),z=m("t-card"),h=m("t-tag"),N=m("t-link"),ze=m("t-popconfirm"),X=m("t-table"),qe=m("t-pagination"),M=m("t-input-number"),w=m("t-form-item"),Y=m("t-alert"),ne=m("t-form"),B=m("t-dialog"),S=m("t-descriptions-item"),De=m("t-descriptions"),ae=m("t-input"),se=m("t-textarea"),de=m("t-divider"),Ke=m("t-switch"),Z=m("t-col"),Se=m("t-row");return u(),P("div",Ee,[s("div",Ge,[e[18]||(e[18]=s("h2",null,"订单管理",-1)),o(A,null,{default:l(()=>[o(_,{theme:"default",onClick:e[0]||(e[0]=t=>R.value=!0)},{icon:l(()=>[o(y,{name:"data"})]),default:l(()=>[e[16]||(e[16]=d(" Mock数据 ",-1))]),_:1}),o(_,{theme:"primary",onClick:ye},{icon:l(()=>[o(y,{name:"add"})]),default:l(()=>[e[17]||(e[17]=d(" 新建订单 ",-1))]),_:1})]),_:1})]),o(z,{class:"filter-card"},{default:l(()=>[o(A,null,{default:l(()=>[o(g,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=t=>C.value=t),placeholder:"订单状态",clearable:"",style:{width:"150px"},onChange:K},{default:l(()=>[o(x,{value:"draft",label:"草稿"}),o(x,{value:"pending",label:"待审批"}),o(x,{value:"approved",label:"已审批"}),o(x,{value:"signed",label:"已签约"}),o(x,{value:"executing",label:"执行中"}),o(x,{value:"completed",label:"已完成"})]),_:1},8,["modelValue"]),o(_,{theme:"default",onClick:Ae},{icon:l(()=>[o(y,{name:"chart-pie"})]),default:l(()=>[e[19]||(e[19]=d(" 查看统计 ",-1))]),_:1})]),_:1})]),_:1}),o(X,{data:G.value,columns:me,loading:r.value,"row-key":"id",stripe:"",hover:"",class:"data-table"},{status:l(({row:t})=>[t.status==="draft"?(u(),v(h,{key:0,theme:"default"},{default:l(()=>[...e[20]||(e[20]=[d("草稿",-1)])]),_:1})):t.status==="pending"?(u(),v(h,{key:1,theme:"warning"},{default:l(()=>[...e[21]||(e[21]=[d("待审批",-1)])]),_:1})):t.status==="approved"?(u(),v(h,{key:2,theme:"success"},{default:l(()=>[...e[22]||(e[22]=[d("已审批",-1)])]),_:1})):t.status==="signed"?(u(),v(h,{key:3,theme:"primary"},{default:l(()=>[...e[23]||(e[23]=[d("已签约",-1)])]),_:1})):t.status==="executing"?(u(),v(h,{key:4},{default:l(()=>[...e[24]||(e[24]=[d("执行中",-1)])]),_:1})):t.status==="completed"?(u(),v(h,{key:5,theme:"success"},{default:l(()=>[...e[25]||(e[25]=[d("已完成",-1)])]),_:1})):(u(),v(h,{key:6},{default:l(()=>[d(c(t.status),1)]),_:2},1024))]),totalAmount:l(({row:t})=>[d(" ¥"+c(t.totalAmount.toFixed(2)),1)]),action:l(({row:t})=>[o(A,null,{default:l(()=>[o(N,{theme:"primary",onClick:f=>ke(t)},{default:l(()=>[...e[26]||(e[26]=[d("查看",-1)])]),_:1},8,["onClick"]),t.status==="draft"?(u(),v(N,{key:0,onClick:f=>_e(t)},{default:l(()=>[...e[27]||(e[27]=[d("编辑",-1)])]),_:1},8,["onClick"])):D("",!0),t.status==="draft"?(u(),v(N,{key:1,onClick:f=>Ve(t.id)},{default:l(()=>[...e[28]||(e[28]=[d("提交审批",-1)])]),_:1},8,["onClick"])):D("",!0),t.status==="approved"?(u(),v(N,{key:2,onClick:f=>Ce(t)},{default:l(()=>[...e[29]||(e[29]=[d("生成合同",-1)])]),_:1},8,["onClick"])):D("",!0),t.status==="draft"?(u(),v(ze,{key:3,content:"确认删除此订单？",onConfirm:f=>we(t.id)},{default:l(()=>[o(N,{theme:"danger"},{default:l(()=>[...e[30]||(e[30]=[d("删除",-1)])]),_:1})]),_:1},8,["onConfirm"])):D("",!0)]),_:2},1024)]),_:1},8,["data","loading"]),o(qe,{modelValue:I.current,"onUpdate:modelValue":e[2]||(e[2]=t=>I.current=t),pageSize:I.pageSize,"onUpdate:pageSize":e[3]||(e[3]=t=>I.pageSize=t),total:I.total,"show-jumper":"",onChange:ve},null,8,["modelValue","pageSize","total"]),o(B,{visible:R.value,"onUpdate:visible":e[5]||(e[5]=t=>R.value=t),header:"生成 Mock 数据",onConfirm:Ie},{default:l(()=>[o(ne,null,{default:l(()=>[o(w,{label:"生成数量"},{default:l(()=>[o(M,{modelValue:L.value,"onUpdate:modelValue":e[4]||(e[4]=t=>L.value=t),min:1,max:100},null,8,["modelValue"])]),_:1}),o(Y,{theme:"info",message:"提示：生成订单前请确保已有产品和客户数据"})]),_:1})]),_:1},8,["visible"]),o(B,{visible:W.value,"onUpdate:visible":e[6]||(e[6]=t=>W.value=t),header:"订单详情",width:"800px"},{default:l(()=>[V.value?(u(),P("div",We,[o(De,{column:2,bordered:""},{default:l(()=>[o(S,{label:"订单编号"},{default:l(()=>[d(c(V.value.orderNo),1)]),_:1}),o(S,{label:"订单状态"},{default:l(()=>[V.value.status==="draft"?(u(),v(h,{key:0,theme:"default"},{default:l(()=>[...e[31]||(e[31]=[d("草稿",-1)])]),_:1})):V.value.status==="pending"?(u(),v(h,{key:1,theme:"warning"},{default:l(()=>[...e[32]||(e[32]=[d("待审批",-1)])]),_:1})):V.value.status==="approved"?(u(),v(h,{key:2,theme:"success"},{default:l(()=>[...e[33]||(e[33]=[d("已审批",-1)])]),_:1})):(u(),v(h,{key:3},{default:l(()=>[d(c(V.value.status),1)]),_:1}))]),_:1}),o(S,{label:"订单标题",span:2},{default:l(()=>[d(c(V.value.title),1)]),_:1}),o(S,{label:"小计金额"},{default:l(()=>{var t;return[d("¥"+c((t=V.value.subtotal)==null?void 0:t.toFixed(2)),1)]}),_:1}),o(S,{label:"折扣金额"},{default:l(()=>{var t;return[d("¥"+c((t=V.value.discount)==null?void 0:t.toFixed(2)),1)]}),_:1}),o(S,{label:"订单总额",span:2},{default:l(()=>{var t;return[s("span",He," ¥"+c((t=V.value.totalAmount)==null?void 0:t.toFixed(2)),1)]}),_:1}),o(S,{label:"创建时间",span:2},{default:l(()=>[d(c(V.value.createdAt),1)]),_:1})]),_:1}),e[36]||(e[36]=s("h4",{style:{"margin-top":"20px"}},"订单明细",-1)),o(X,{data:V.value.items,columns:ce,size:"small"},null,8,["data"]),Q.value.length>0?(u(),P("div",Le,[e[35]||(e[35]=s("h4",null,"智能推荐",-1)),o(Y,{theme:"success",message:"根据历史订单数据，为您推荐以下产品"}),s("div",Je,[(u(!0),P(ee,null,te(Q.value,t=>(u(),v(z,{key:t.product.id,style:{"margin-bottom":"10px"}},{default:l(()=>[s("div",Qe,[s("div",null,[s("strong",null,c(t.product.name),1),s("div",Xe,c(t.recommendation.reason),1),s("div",Ye," 置信度: "+c((t.recommendation.confidence*100).toFixed(1))+"% ",1)]),o(_,{size:"small",onClick:f=>Ue(t.product)},{default:l(()=>[...e[34]||(e[34]=[d("添加",-1)])]),_:1},8,["onClick"])])]),_:2},1024))),128))])])):D("",!0)])):D("",!0)]),_:1},8,["visible"]),o(B,{visible:j.value,"onUpdate:visible":e[14]||(e[14]=t=>j.value=t),header:J.value==="create"?"新建订单":"编辑订单",width:"900px",onConfirm:ge},{default:l(()=>[T.value.length===0||$.value.length===0?(u(),v(Y,{key:0,theme:"warning",message:T.value.length===0?"暂无客户数据，请先在客户管理中创建客户":"暂无产品数据，请先在产品管理中创建产品",style:{"margin-bottom":"16px"}},null,8,["message"])):D("",!0),o(ne,{ref:"formRef",data:a,rules:fe,"label-width":"100px"},{default:l(()=>[o(w,{label:"订单标题",name:"title"},{default:l(()=>[o(ae,{modelValue:a.title,"onUpdate:modelValue":e[7]||(e[7]=t=>a.title=t),placeholder:"请输入订单标题"},null,8,["modelValue"])]),_:1}),o(w,{label:"客户",name:"customerId"},{default:l(()=>[o(g,{modelValue:a.customerId,"onUpdate:modelValue":e[8]||(e[8]=t=>a.customerId=t),placeholder:"请选择客户",filterable:"",loading:r.value},{default:l(()=>[(u(!0),P(ee,null,te(T.value,t=>(u(),v(x,{key:t.id,value:t.id,label:t.name},{default:l(()=>[s("div",Ze,[s("span",null,c(t.name),1),s("span",et,c(t.company||t.phone),1)])]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),o(w,{label:"订单描述"},{default:l(()=>[o(se,{modelValue:a.description,"onUpdate:modelValue":e[9]||(e[9]=t=>a.description=t),placeholder:"请输入订单描述",maxlength:500},null,8,["modelValue"])]),_:1}),o(w,{label:"付款条款",name:"paymentTerms"},{default:l(()=>[o(ae,{modelValue:a.paymentTerms,"onUpdate:modelValue":e[10]||(e[10]=t=>a.paymentTerms=t),placeholder:"如：30天内付款"},null,8,["modelValue"])]),_:1}),o(de,null,{default:l(()=>[...e[37]||(e[37]=[d("订单明细",-1)])]),_:1}),s("div",tt,[o(_,{size:"small",onClick:be},{icon:l(()=>[o(y,{name:"add"})]),default:l(()=>[e[38]||(e[38]=d(" 添加产品 ",-1))]),_:1})]),s("div",lt,[o(X,{data:a.items,columns:pe,size:"small","max-height":"300","table-layout":"fixed"},{productId:l(({row:t,rowIndex:f})=>[o(g,{modelValue:t.productId,"onUpdate:modelValue":U=>t.productId=U,placeholder:"选择产品",filterable:"",onChange:U=>he(U,f)},{default:l(()=>[(u(!0),P(ee,null,te($.value,U=>(u(),v(x,{key:U.id,value:U.id,label:U.name},{default:l(()=>[s("div",ot,[s("span",null,c(U.name),1),s("span",nt,"￥"+c(U.price),1)])]),_:2},1032,["value","label"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),quantity:l(({row:t})=>[o(M,{modelValue:t.quantity,"onUpdate:modelValue":f=>t.quantity=f,min:1,onChange:f=>O(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),unitPrice:l(({row:t})=>[o(M,{modelValue:t.unitPrice,"onUpdate:modelValue":f=>t.unitPrice=f,min:0,onChange:f=>O(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),discount:l(({row:t})=>[o(M,{modelValue:t.discount,"onUpdate:modelValue":f=>t.discount=f,min:0,onChange:f=>O(t)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),amount:l(({row:t})=>{var f;return[d(" ￥"+c(((f=t.amount)==null?void 0:f.toFixed(2))||"0.00"),1)]}),action:l(({rowIndex:t})=>[o(N,{theme:"danger",onClick:f=>xe(t)},{default:l(()=>[...e[39]||(e[39]=[d("删除",-1)])]),_:1},8,["onClick"])]),_:1},8,["data"])]),o(de),o(w,{label:"小计金额"},{default:l(()=>[s("span",at,"￥"+c(le().toFixed(2)),1)]),_:1}),o(w,{label:"折扣金额"},{default:l(()=>[o(M,{modelValue:a.discount,"onUpdate:modelValue":e[11]||(e[11]=t=>a.discount=t),min:0},null,8,["modelValue"])]),_:1}),o(w,{label:"订单总额"},{default:l(()=>[s("span",st," ￥"+c(oe().toFixed(2)),1)]),_:1}),o(w,{label:"需要审批"},{default:l(()=>[o(Ke,{modelValue:a.requireApproval,"onUpdate:modelValue":e[12]||(e[12]=t=>a.requireApproval=t)},null,8,["modelValue"])]),_:1}),o(w,{label:"备注"},{default:l(()=>[o(se,{modelValue:a.notes,"onUpdate:modelValue":e[13]||(e[13]=t=>a.notes=t),placeholder:"请输入备注",maxlength:500},null,8,["modelValue"])]),_:1})]),_:1},8,["data"])]),_:1},8,["visible","header"]),o(B,{visible:H.value,"onUpdate:visible":e[15]||(e[15]=t=>H.value=t),header:"订单统计",width:"600px"},{default:l(()=>[F.value?(u(),P("div",dt,[o(Se,{gutter:16},{default:l(()=>[o(Z,{span:6},{default:l(()=>[o(z,null,{default:l(()=>[s("div",it,[s("div",ut,c(F.value.total),1),e[40]||(e[40]=s("div",{style:{color:"#888"}},"订单总数",-1))])]),_:1})]),_:1}),o(Z,{span:6},{default:l(()=>[o(z,null,{default:l(()=>{var t;return[s("div",rt,[s("div",mt,"¥"+c((t=F.value.totalAmount)==null?void 0:t.toFixed(0)),1),e[41]||(e[41]=s("div",{style:{color:"#888"}},"总金额",-1))])]}),_:1})]),_:1}),o(Z,{span:6},{default:l(()=>[o(z,null,{default:l(()=>{var t;return[s("div",ct,[s("div",pt,"¥"+c((t=F.value.avgAmount)==null?void 0:t.toFixed(0)),1),e[42]||(e[42]=s("div",{style:{color:"#888"}},"平均金额",-1))])]}),_:1})]),_:1})]),_:1})])):D("",!0)]),_:1},8,["visible"])])}}}),xt=$e(ft,[["__scopeId","data-v-1fb0869a"]]);export{xt as default};
